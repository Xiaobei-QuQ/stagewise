# Vibe Admin Agent 设计方案

## 1. 背景与目标

### 1.1 背景

传统的中后台系统开发面临以下痛点：

- **重复性工作多**：大量 CRUD 页面、表单配置、表格列定义等重复劳动
- **上下文切换频繁**：开发者需要在 IDE、浏览器、设计稿、文档之间反复切换
- **非技术人员参与困难**：业务运营想调整页面文案或布局，需要提需求等开发排期

### 1.2 目标

构建 **Vibe Admin Agent**，实现：

1. **可视化驱动开发**：用户在浏览器中选中元素，用自然语言描述需求，AI 自动完成修改
2. **全栈自主决策**：AI 能判断需要修改哪些文件（前端组件、后端接口、配置文件），自动完成端到端改动
3. **业务领域增强**：通过 Skill 机制注入业务知识，AI 理解项目约定和最佳实践
4. **双角色支持**：
   - 开发者：加速复杂功能开发
   - 运营人员：自助完成简单配置修改

---

## 2. 产品能力概述

### 2.1 核心使用流程

```
用户在浏览器中操作 → 选中目标元素 → 输入自然语言需求 → AI 自主分析并修改代码 → 页面实时更新
```

### 2.2 典型场景

| 场景 | 用户操作 | AI 行为 |
|-----|---------|--------|
| 修改表格列 | 选中表格，说"把创建时间列改成可排序" | 修改表格配置，添加 sorter 属性 |
| 新增表单字段 | 选中表单，说"加一个手机号输入框，要校验格式" | 新增表单项，添加正则校验规则 |
| 调整页面布局 | 选中区块，说"把这两个卡片改成左右并排" | 修改 Flex/Grid 布局样式 |
| 新增 API 接口 | 说"给用户列表加一个批量删除接口" | 新增后端接口 + 前端调用代码 |
| 修改业务逻辑 | 说"审批通过后自动发送通知" | 修改后端逻辑 + 添加通知调用 |

### 2.3 效果截图

> [截图位置：Toolbar 选中元素]

> [截图位置：输入自然语言需求]

> [截图位置：AI 执行过程流式展示]

> [截图位置：页面实时更新效果]

---

## 3. 整体架构

### 3.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Browser (localhost)                           │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                        业务系统 (iframe)                          │  │
│  │                     uni-admin / 其他中后台                        │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                     Stagewise Toolbar (覆盖层)                    │  │
│  │  - 元素选择器：点击选中 DOM 元素                                   │  │
│  │  - 聊天界面：输入自然语言需求                                      │  │
│  │  - 执行状态：展示 AI 思考和操作过程                                │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────┬───────────────────────────────────────────────┘
                          │ WebSocket
                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         Stagewise CLI (Node.js)                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   Proxy Server  │  │  Karton Server  │  │      Agent Loader       │  │
│  │  代理业务系统   │  │  状态同步通信   │  │  加载 AI Agent 后端     │  │
│  └─────────────────┘  └─────────────────┘  └───────────┬─────────────┘  │
└───────────────────────────────────────────────────────┬─────────────────┘
                                                        │ spawn 子进程
                                                        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          AI Agent 后端                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  - 理解用户意图                                                  │   │
│  │  - 读取项目文件，分析代码结构                                    │   │
│  │  - 自主决策修改方案                                              │   │
│  │  - 执行文件读写、命令运行                                        │   │
│  │  - 流式输出执行过程                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Business Skills                           │   │
│  │  - 项目结构说明                                                  │   │
│  │  - 组件库使用规范                                                │   │
│  │  - 代码风格约定                                                  │   │
│  │  - 业务领域知识                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                          │ 文件修改
                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        业务系统 Dev Server                              │
│                    Vite / Webpack / Next.js / etc.                      │
│                          ↓ HMR 热更新                                   │
│                     Browser 页面自动刷新                                │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 数据流

```
1. 用户在 Toolbar 中选中元素 + 输入需求
                    ↓
2. Toolbar 收集上下文（DOM 信息、截图、插件数据）
                    ↓
3. 通过 WebSocket 发送到 Stagewise CLI
                    ↓
4. CLI 调用 AI Agent 后端，传入上下文
                    ↓
5. AI Agent 分析需求，读取项目文件
                    ↓
6. AI Agent 执行修改（可能涉及多个文件）
                    ↓
7. Dev Server 检测文件变化，触发 HMR
                    ↓
8. Browser 页面自动更新
                    ↓
9. AI Agent 输出流式回传到 Toolbar 展示
```

---

## 4. 核心模块设计

### 4.1 Stagewise 改造

#### 4.1.1 新增 Agent 抽象层

原有架构直接调用 Anthropic API，改造后支持可插拔的 Agent 后端：

```typescript
// 通过 CLI 参数选择 Agent 类型
stagewise dev --agent claude-code -a 3334

// Agent 接口抽象
interface AgentBackend {
  initialize(): Promise<{ wss: WebSocketServer }>;
  handleUserMessage(message: ChatMessage): Promise<void>;
  abort(): void;
  shutdown(): void;
}
```

#### 4.1.2 上下文传递增强

Toolbar 收集的上下文通过结构化格式传递给 AI Agent：

| 上下文类型 | 内容 | 用途 |
|-----------|-----|-----|
| 选中元素 | XPath、属性、文本内容 | 定位修改目标 |
| 页面截图 | Base64 图片 | 视觉理解 |
| 插件数据 | 框架类型、组件信息 | 项目上下文 |
| 业务 Skill | 项目约定、领域知识 | 指导 AI 行为 |

#### 4.1.3 流式输出展示

AI Agent 的执行过程实时展示在 Toolbar 中：

- 正在思考的内容
- 正在读取的文件
- 正在执行的修改
- 执行结果和错误信息

### 4.2 业务系统接入

#### 4.2.1 零代码改动启动

业务系统无需任何代码改动，只需启动 CLI：

```bash
# 在业务项目目录下
stagewise dev --agent claude-code -a <业务系统端口>
```

#### 4.2.2 Skill 机制增强

通过在项目中添加 Skill 文件，注入业务知识：

```
业务项目/
├── .stagewise/
│   └── skills/
│       ├── project-structure.md    # 项目结构说明
│       ├── component-guide.md      # 组件使用规范
│       ├── api-convention.md       # 接口约定
│       └── business-rules.md       # 业务规则
├── src/
└── ...
```

Skill 文件示例：

```markdown
# project-structure.md

## 目录结构

- `src/pages/` - 页面组件，每个文件夹对应一个路由
- `src/components/` - 公共组件
- `src/services/` - API 接口定义
- `src/models/` - 数据模型和状态管理

## 新增页面流程

1. 在 `src/pages/` 下创建页面文件夹
2. 在 `src/routes.ts` 中添加路由配置
3. 在 `src/menu.ts` 中添加菜单项（如需要）

## 代码风格

- 使用 TypeScript
- 组件使用函数式 + Hooks
- 样式使用 CSS Modules
```

#### 4.2.3 插件扩展（可选）

对于需要深度集成的场景，可开发 Stagewise 插件：

```typescript
// stagewise-plugin-uni-admin.ts
export default {
  name: 'uni-admin',

  // 提供组件元数据
  getComponentInfo(element: HTMLElement) {
    return {
      componentName: element.dataset.component,
      props: parsePropsFromElement(element),
    };
  },

  // 注入额外上下文
  getContextSnippets() {
    return [
      { name: 'formily-schema', content: '...' },
      { name: 'pro-table-config', content: '...' },
    ];
  },
};
```

---

## 5. 接入指南

### 5.1 快速开始

**步骤 1：启动业务系统**

```bash
cd /path/to/your-project
pnpm dev  # 假设运行在 3334 端口
```

**步骤 2：启动 Vibe Admin Agent**

```bash
stagewise dev --agent claude-code -a 3334 -p 3335
```

**步骤 3：打开浏览器**

访问 `http://localhost:3335`，即可看到带有 Toolbar 的业务系统。

### 5.2 编写 Business Skill

在项目根目录创建 `.stagewise/skills/` 文件夹，添加 Markdown 文件描述业务知识。

**推荐的 Skill 类型：**

| Skill 文件 | 内容建议 |
|-----------|---------|
| `project-structure.md` | 目录结构、文件命名约定 |
| `component-guide.md` | 使用的组件库、常用组件示例 |
| `api-convention.md` | 接口定义规范、请求/响应格式 |
| `business-rules.md` | 业务术语、领域规则 |
| `code-style.md` | 代码风格、最佳实践 |

**Skill 编写原则：**

1. **具体而非抽象** - 给出具体的文件路径、代码示例
2. **面向操作** - 描述"如何做"而非"是什么"
3. **保持更新** - 随项目演进更新 Skill 内容

### 5.3 高级配置

**配置文件 `stagewise.config.json`：**

```json
{
  "agent": "claude-code",
  "skills": [".stagewise/skills/**/*.md"],
  "allowedPaths": ["src/", "config/"],
  "deniedPaths": ["node_modules/", ".git/"]
}
```

---

## 附录：技术决策说明

### A.1 为什么使用 AI Agent 后端而非直接调用 API

| 方案 | 优点 | 缺点 |
|-----|-----|-----|
| 直接调用 API | 简单、可控 | 能力有限，无法自主读写文件 |
| AI Agent 后端 | 自主决策、全栈能力 | 需要额外进程、复杂度高 |

选择 AI Agent 后端是因为：
1. 支持自主读取项目文件，理解代码上下文
2. 支持自主执行命令（如运行测试、格式化代码）
3. 支持多轮对话中的持续修改

### A.2 Skill 机制 vs 传统 Prompt Engineering

Skill 机制的优势：
1. **可维护** - Markdown 文件易于版本控制和协作编辑
2. **可组合** - 多个 Skill 文件可按需加载
3. **业务绑定** - Skill 与业务项目一起管理，保持同步

### A.3 流式输出的必要性

流式输出让用户能够：
1. 实时了解 AI 正在做什么
2. 在错误发生时及时中断
3. 对长时间任务保持信心
